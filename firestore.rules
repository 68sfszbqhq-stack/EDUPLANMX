rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCIONES HELPER
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function belongsToSchool(schoolId) {
      return isAuthenticated() && getUserData().schoolId == schoolId;
    }
    
    function isDirector() {
      return isAuthenticated() && getUserData().rol == 'directivo';
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().rol == 'superadmin';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // PLANEACIONES (AISLAMIENTO TOTAL)
    // ============================================
    
    match /planeaciones/{planId} {
      // Leer: Solo de tu escuela
      allow read: if isAuthenticated() 
                  && belongsToSchool(resource.data.schoolId);
      
      // Crear: Solo si eres de esa escuela y eres el autor
      allow create: if isAuthenticated() 
                    && belongsToSchool(request.resource.data.schoolId)
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.schoolId != null
                    && request.resource.data.userId != null;
      
      // Actualizar: Solo si eres el autor
      allow update: if isAuthenticated()
                    && isOwner(resource.data.userId)
                    && belongsToSchool(resource.data.schoolId)
                    && request.resource.data.schoolId == resource.data.schoolId; // No cambiar schoolId
      
      // Eliminar: Solo si eres el autor o director de la escuela
      allow delete: if isAuthenticated()
                    && (isOwner(resource.data.userId) 
                        || (isDirector() && belongsToSchool(resource.data.schoolId)));
    }
    
    // ============================================
    // ESCUELAS
    // ============================================
    
    match /schools/{schoolId} {
      // Leer: Solo tu escuela o super admin
      allow read: if belongsToSchool(schoolId) || isSuperAdmin();
      
      // Crear: Solo super admin
      allow create: if isSuperAdmin();
      
      // Actualizar: Director de la escuela o super admin
      allow update: if (belongsToSchool(schoolId) && isDirector()) 
                    || isSuperAdmin();
      
      // Eliminar: Solo super admin
      allow delete: if isSuperAdmin();
    }
    
    // ============================================
    // USUARIOS
    // ============================================
    
    match /users/{userId} {
      // Leer tu propio perfil siempre (incluso si no existe aún)
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Leer otros de tu escuela (solo si el documento existe)
      allow read: if isAuthenticated() 
                  && resource != null
                  && resource.data.schoolId != null
                  && getUserData().schoolId == resource.data.schoolId;
      
      // Crear tu propio perfil durante login/onboarding
      allow create: if isAuthenticated() 
                    && request.auth.uid == userId
                    && request.resource.data.id == request.auth.uid;
      
      // Actualizar solo tu perfil (no puedes cambiar rol ni schoolId después de creado)
      allow update: if isAuthenticated()
                    && request.auth.uid == userId
                    && (!exists(/databases/$(database)/documents/users/$(userId)) 
                        || (request.resource.data.rol == resource.data.rol
                            && (resource.data.schoolId == null || request.resource.data.schoolId == resource.data.schoolId)));
      
      // Super admin puede leer/escribir todo
      allow read, write: if isSuperAdmin();
    }
    
    // ============================================
    // ALUMNOS
    // ============================================
    
    match /alumnos/{alumnoId} {
      // Solo de tu escuela
      allow read, write: if isAuthenticated()
                         && belongsToSchool(resource.data.schoolId);
      
      // Crear: Validar schoolId
      allow create: if isAuthenticated()
                    && belongsToSchool(request.resource.data.schoolId);
    }
    
    // ============================================
    // ASIGNACIONES (Materias/Grupos)
    // ============================================
    
    match /asignaciones/{asignacionId} {
      // Solo de tu escuela
      allow read, write: if isAuthenticated()
                         && belongsToSchool(resource.data.schoolId);
      
      // Crear: Validar schoolId
      allow create: if isAuthenticated()
                    && belongsToSchool(request.resource.data.schoolId);
    }
    
    // ============================================
    // PMC (Programa de Mejora Continua)
    // ============================================
    
    match /pmc/{pmcId} {
      // Solo de tu escuela
      allow read: if isAuthenticated()
                  && belongsToSchool(resource.data.schoolId);
      
      // Escribir: Solo directores de la escuela
      allow write: if isAuthenticated()
                   && belongsToSchool(resource.data.schoolId)
                   && isDirector();
    }
    
    // ============================================
    // PAEC (Programa Anual de Educación Continua)
    // ============================================
    
    match /paec/{paecId} {
      // Solo de tu escuela
      allow read: if isAuthenticated()
                  && belongsToSchool(resource.data.schoolId);
      
      // Escribir: Solo directores de la escuela
      allow write: if isAuthenticated()
                   && belongsToSchool(resource.data.schoolId)
                   && isDirector();
    }
    
    // ============================================
    // API USAGE (Solo Super Admin)
    // ============================================
    
    match /api_usage/{usageId} {
      allow read, write: if isSuperAdmin();
    }
    
    match /api_quotas/{quotaId} {
      allow read, write: if isSuperAdmin();
    }
    
    // ============================================
    // DIAGNÓSTICOS
    // ============================================
    
    match /diagnosticos/{diagnosticoId} {
      // Solo de tu escuela
      allow read, write: if isAuthenticated()
                         && belongsToSchool(resource.data.schoolId);
      
      // Crear: Validar schoolId
      allow create: if isAuthenticated()
                    && belongsToSchool(request.resource.data.schoolId);
    }
    
    // ============================================
    // REGLA POR DEFECTO: DENEGAR TODO
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
