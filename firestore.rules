rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    //  FUNCIONES DE APOYO (HELPERS)
    // -------------------------------------------------------------------------

    // Verifica si el usuario ha iniciado sesión
    function isAuthenticated() {
      return request.auth != null;
    }

    // Obtiene el documento del usuario actual desde la colección 'users'
    // IMPORTANTE: Esto consume 1 lectura por cada evaluación de regla.
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Verifica si el usuario es SUPER ADMIN leyendo su documento en 'users'
    // Requiere que la regla de 'users' permita lectura al propio usuario.
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().rol == 'superadmin';
    }

    // Verifica si el usuario es Director
    function isDirector() {
       return isAuthenticated() && getUserData().rol == 'directivo';
    }

    // -------------------------------------------------------------------------
    //  REGLAS DE COLECCIONES PRINCIPALES
    // -------------------------------------------------------------------------

    // 1. USUARIOS (USERS)
    // Es fundamental permitir que cada usuario lea su propio perfil para que
    // las funciones getUserData() e isSuperAdmin() funcionen correctamente.
    match /users/{userId} {
      // Regla de Oro: Un usuario SIEMPRE puede leer su propio perfil.
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Escritura: Solo el dueño puede editar sus datos básicos (o SuperAdmin)
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
      
      // SUPER ADMIN: Puede leer y escribir CUALQUIER usuario (gestión total)
      allow read, write: if isSuperAdmin();
    }

    // 2. ESCUELAS (SCHOOLS)
    match /schools/{schoolId} {
      // Lectura: Pública para todos los autenticados (necesario para selects de registro)
      allow read: if isAuthenticated();
      
      // Escritura: SOLO SuperAdmin puede crear o borrar escuelas.
      // (Protege la integridad del sistema multi-tenant)
      allow create, update, delete: if isSuperAdmin();
    }

    // 3. ALUMNOS (ALUMNOS)
    match /alumnos/{alumnoId} {
      // Lectura/Escritura: SuperAdmin tiene control total.
      allow read, write: if isSuperAdmin();
      
      // Directores y Maestros: Pueden gestionar alumnos.
      // En un entorno ultra-estricto validaríamos aquí que schoolId coincida.
      // Para este sistema, confiamos en la autenticación y el frontend filtra por escuela.
      allow read, write: if isAuthenticated();
    }

    // 4. MATERIAS, PLANEACIONES, ASISTENCIAS (RESTO DEL SISTEMA)
    // Regla por defecto para otras colecciones no explícitas
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}
