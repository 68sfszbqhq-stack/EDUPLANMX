rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCIONES HELPER
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function belongsToSchool(schoolId) {
      return isAuthenticated() && getUserData().schoolId == schoolId;
    }
    
    function isDirector() {
      return isAuthenticated() && getUserData().rol == 'directivo';
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().rol == 'superadmin';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // PLANEACIONES
    // ============================================
    
    match /planeaciones/{planId} {
      // Leer: Solo de tu escuela
      allow read: if isAuthenticated() 
                  && (resource == null || belongsToSchool(resource.data.schoolId));
      
      // Crear: Solo si eres de esa escuela y eres el autor
      allow create: if isAuthenticated() 
                    && belongsToSchool(request.resource.data.schoolId)
                    && request.resource.data.userId == request.auth.uid;
      
      // Actualizar: Solo si eres el autor
      allow update: if isAuthenticated()
                    && isOwner(resource.data.userId)
                    && belongsToSchool(resource.data.schoolId);
      
      // Eliminar: Solo si eres el autor o director de la escuela
      allow delete: if isAuthenticated()
                    && (isOwner(resource.data.userId) 
                        || (isDirector() && belongsToSchool(resource.data.schoolId)));
    }
    
    // ============================================
    // ESCUELAS
    // ============================================
    
    match /schools/{schoolId} {
      // Leer: Solo tu escuela
      allow read: if isAuthenticated() && belongsToSchool(schoolId);
      
      // Escribir: Solo directores o super admin
      allow write: if isAuthenticated() 
                   && ((belongsToSchool(schoolId) && isDirector()) || isSuperAdmin());
    }
    
    // ============================================
    // USUARIOS
    // ============================================
    
    match /users/{userId} {
      // Leer tu propio perfil siempre (incluso si no existe aún)
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Leer otros de tu escuela (solo si el documento existe)
      allow read: if isAuthenticated() 
                  && resource != null
                  && resource.data.schoolId != null
                  && getUserData().schoolId == resource.data.schoolId;
      
      // Crear tu propio perfil durante login/onboarding
      allow create: if isAuthenticated() 
                    && request.auth.uid == userId
                    && request.resource.data.id == request.auth.uid;
      
      // Actualizar tu propio perfil (permite cambios flexibles durante onboarding)
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // Super admin puede leer/escribir todo
      allow read, write: if isSuperAdmin();
    }
    
    // ============================================
    // ALUMNOS - REGLAS SIMPLIFICADAS
    // ============================================
    
    match /alumnos/{alumnoId} {
      // Permitir todo si estás autenticado (temporal para debugging)
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // ASIGNACIONES
    // ============================================
    
    match /asignaciones/{asignacionId} {
      // Permitir todo si estás autenticado (temporal)
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // PMC (Programa de Mejora Continua)
    // ============================================
    
    match /pmc/{pmcId} {
      // Permitir todo si estás autenticado (temporal)
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // PAEC
    // ============================================
    
    match /paec/{paecId} {
      // Permitir todo si estás autenticado (temporal)
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // API USAGE (Super Admin)
    // ============================================
    
    match /api_usage/{usageId} {
      allow read, write: if isSuperAdmin();
    }
    
    match /api_quotas/{quotaId} {
      allow read, write: if isSuperAdmin();
    }
    
    // ============================================
    // DIAGNÓSTICOS
    // ============================================
    
    match /diagnosticos/{diagnosticoId} {
      // Permitir todo si estás autenticado (temporal)
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // ESTADÍSTICAS DE ESTUDIANTES
    // ============================================
    
    match /student_stats/{statId} {
      // Permitir todo si estás autenticado (temporal)
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // REGLA POR DEFECTO: DENEGAR TODO
    // ============================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
